version: '3.8'

# ============================================================
# Prebuilt Images Deployment
# ============================================================
# Uses images from Gitea Container Registry instead of building.
# Used by Coolify provisioning for fast instance deployment.
# ============================================================

services:
  backend:
    image: 192.168.1.70:3000/janbndrf/tabtin-backend:latest
    environment:
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:?}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD:?}
      - PB_BATCH_ENABLED=${PB_BATCH_ENABLED:-true}
      - PB_BATCH_MAX_REQUESTS=${PB_BATCH_MAX_REQUESTS:-100}
      - PB_BATCH_TIMEOUT=${PB_BATCH_TIMEOUT:-30}
      - PB_BATCH_MAX_BODY_SIZE=${PB_BATCH_MAX_BODY_SIZE:-134217728}
    volumes:
      - pb_data:/pb/pb_data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    image: 192.168.1.70:3000/janbndrf/tabtin-frontend:latest
    environment:
      - DOCKER_ENV=true
      - POCKETBASE_URL=http://backend:8090
      - ADDON_NETWORK=tabtin-network
      - ADDON_DATA_PATH=/app/addon-data
      - ADDONS_DIR=/app/addons
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:?}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD:?}
      - INSTANCE_MAX_CONCURRENT_PROJECTS=${INSTANCE_MAX_CONCURRENT_PROJECTS:-1}
      - INSTANCE_MAX_PARALLEL_REQUESTS=${INSTANCE_MAX_PARALLEL_REQUESTS:-10}
      - INSTANCE_MAX_REQUESTS_PER_MINUTE=${INSTANCE_MAX_REQUESTS_PER_MINUTE:-60}
      - PREDEFINED_ENDPOINTS=${PREDEFINED_ENDPOINTS:-[]}
      - BODY_SIZE_LIMIT=${BODY_SIZE_LIMIT:-50M}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - addon_data:/app/addon-data
      - nginx_cache:/var/cache/nginx
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 8.8.8.8
      - 8.8.4.4
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  app-network:

volumes:
  pb_data:
  addon_data:
  nginx_cache:
