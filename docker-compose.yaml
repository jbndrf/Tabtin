version: '3.8'

# ============================================================
# Environment Variables (Coolify + Self-Hosters)
# ============================================================
# Coolify: Variables with ${VAR} syntax are auto-detected and shown in UI
# Self-hosters: Create .env file from .env.example, docker-compose reads it
#
# Required variables (marked with :?):
#   - POCKETBASE_ADMIN_EMAIL
#   - POCKETBASE_ADMIN_PASSWORD
#
# Optional variables (have defaults with :-):
#   - INSTANCE_MAX_CONCURRENT_PROJECTS (default: 1)
#   - INSTANCE_MAX_PARALLEL_REQUESTS (default: 10)
#   - INSTANCE_MAX_REQUESTS_PER_MINUTE (default: 60)
#   - PREDEFINED_ENDPOINTS (default: [])
#   - BODY_SIZE_LIMIT (default: 50M)
#   - PB_BATCH_* settings
# ============================================================

services:
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
    # Self-hosters: Uncomment to set fixed container name
    # container_name: pocketbase-backend
    environment:
      # Required: Admin credentials for first-run setup
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:?}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD:?}
      # Optional: PocketBase Batch API settings
      - PB_BATCH_ENABLED=${PB_BATCH_ENABLED:-true}
      - PB_BATCH_MAX_REQUESTS=${PB_BATCH_MAX_REQUESTS:-100}
      - PB_BATCH_TIMEOUT=${PB_BATCH_TIMEOUT:-30}
      - PB_BATCH_MAX_BODY_SIZE=${PB_BATCH_MAX_BODY_SIZE:-134217728}
    volumes:
      - ./data/pb_data:/pb/pb_data
    # Self-hosters: Uncomment to expose PocketBase directly (for admin UI access)
    # ports:
    #   - "8090:8090"
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8090/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
    # Traefik labels are injected dynamically by Coolify provisioning via docker-compose.override.yaml
    # Self-hosters: Uncomment and configure labels manually, or use ports instead
    # labels:
    #   - traefik.enable=true
    #   - "traefik.http.routers.frontend.rule=Host(`your-domain.com`)"
    #   - traefik.http.routers.frontend.entryPoints=http
    #   - traefik.http.services.frontend.loadbalancer.server.port=80
    # Self-hosters: Uncomment to set fixed container name
    # container_name: sveltekit-frontend
    environment:
      # Internal: Docker environment detection (do not change)
      - DOCKER_ENV=true
      - POCKETBASE_URL=http://backend:8090
      - ADDON_NETWORK=tabtin-network
      - ADDON_DATA_PATH=/app/addon-data
      - ADDONS_DIR=/app/addons
      # Required: Admin credentials (for queue worker authentication)
      - POCKETBASE_ADMIN_EMAIL=${POCKETBASE_ADMIN_EMAIL:?}
      - POCKETBASE_ADMIN_PASSWORD=${POCKETBASE_ADMIN_PASSWORD:?}
      # Optional: Instance limits (global caps)
      - INSTANCE_MAX_CONCURRENT_PROJECTS=${INSTANCE_MAX_CONCURRENT_PROJECTS:-1}
      - INSTANCE_MAX_PARALLEL_REQUESTS=${INSTANCE_MAX_PARALLEL_REQUESTS:-10}
      - INSTANCE_MAX_REQUESTS_PER_MINUTE=${INSTANCE_MAX_REQUESTS_PER_MINUTE:-60}
      # Optional: Predefined LLM endpoints (JSON array)
      - PREDEFINED_ENDPOINTS=${PREDEFINED_ENDPOINTS:-[]}
      # Optional: Upload size limit
      - BODY_SIZE_LIMIT=${BODY_SIZE_LIMIT:-50M}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./data/addons:/app/addon-data
      - nginx_cache:/var/cache/nginx
    # Self-hosters: Uncomment to expose on port 80 directly
    # ports:
    #   - "80:80"
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    # Add host.docker.internal to allow container to reach host machine
    extra_hosts:
      - "host.docker.internal:host-gateway"
    # Use host DNS for proper LAN hostname resolution
    dns:
      - 8.8.8.8
      - 8.8.4.4
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

networks:
  app-network:
    # Self-hosters: Uncomment for custom network config
    # name: tabtin-network
    # driver: bridge
    # driver_opts:
    #   com.docker.network.bridge.name: br-app
    # ipam:
    #   config:
    #     - subnet: 172.27.0.0/16

volumes:
  nginx_cache:
